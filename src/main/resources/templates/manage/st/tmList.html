<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>列表页</title>
<!-- 1 bootstrap基础css -->
<link href="${gateway}/libs/bootstrap-3.3.7-dist/css/bootstrap.css"
  rel="stylesheet">
<!-- 2 table表格css -->
<link
  href="${gateway}/libs/bootstrap-3.3.7-dist/css/bootstrap-table.min.css"
  rel="stylesheet">
<!-- 3 treeview树css -->
<link
  href="${gateway}/libs/bootstrap-3.3.7-dist/css/bootstrap-treeview.min.css"
  rel="stylesheet">
<!-- 4 datetimepicker时间选择css -->
<link
  href="${gateway}/libs/bootstrap-3.3.7-dist/css/bootstrap-datetimepicker.min.css"
  rel="stylesheet">
<!-- 5 select选择框css -->
<link
  href="${gateway}/libs/bootstrap-3.3.7-dist/css/bootstrap-select.css"
  rel="stylesheet">
<!-- 6 fileinput上传文件css -->
<link href="${gateway}/libs/bootstrap-3.3.7-dist/css/fileinput.min.css"
  rel="stylesheet">
<!-- 7 icheck单选+多选css -->
<link href="${gateway}/libs/bootstrap-3.3.7-dist/css/icheck-blue.css"
  rel="stylesheet">
<!-- 8 Validator验证css -->
<link
  href="${gateway}/libs/bootstrap-3.3.7-dist/css/bootstrapValidator.min.css"
  rel="stylesheet">
<!-- 10 引入字体css -->
<link href="${gateway}/libs/bootstrap-3.3.7-dist/fonts/iconfont.css"
  rel="stylesheet">
<!-- 11 页面样式css -->
<link href="${gateway}/src/css/pt-main.css" rel="stylesheet">

<!-- 优先引入jquery1.12.4版本 -->
<script src="${gateway}/libs/jquery/jquery-1.12.4.js"></script>
<!-- 1 bootstrap基础js -->
<script src="${gateway}/libs/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
<!-- 2 table表格js -->
<script
  src="${gateway}/libs/bootstrap-3.3.7-dist/js/bootstrap-table.min.js"></script>
<!-- 3 table列表数据js simple-table -->
<script
  src="${gateway}/libs/bootstrap-3.3.7-dist/js/bootstrap-table-data.js"></script>
<!-- 4 treeview树js -->
<script
  src="${gateway}/libs/bootstrap-3.3.7-dist/js/bootstrap-treeview.js"></script>
<!-- 5 datetimepicker时间选择js -->
<script
  src="${gateway}/libs/bootstrap-3.3.7-dist/js/bootstrap-datetimepicker.js"></script>
<!-- 6 select选择框js -->
<script
  src="${gateway}/libs/bootstrap-3.3.7-dist/js/bootstrap-select.min.js"></script>
<!-- 7 fileinput上传文件js -->
<script src="${gateway}/libs/bootstrap-3.3.7-dist/js/fileinput.min.js"></script>
<!-- 8 fileinput中文包js -->
<script
  src="${gateway}/libs/bootstrap-3.3.7-dist/js/fileinput_locale_zh.js"></script>
<!-- 9 icheck单选+多选js -->
<script src="${gateway}/libs/bootstrap-3.3.7-dist/js/icheck.min.js"></script>
<!-- 10 Validator验证js -->
<script
  src="${gateway}/libs/bootstrap-3.3.7-dist/js/bootstrapValidator.min.js"></script>
<!-- 11 layer弹框js -->
<script src="${gateway}/libs/layer/layer.js"></script>
<!-- 9 layer弹框css -->
<link href="${gateway}/libs/layer/layer-new.css" rel="stylesheet">
<!-- 12 页面js -->
<script src="${gateway}/src/js/main.js"></script>
</head>
<body>
	<div class="pt-page">
		<div class="pt-root-container">
			<!--主视口 -->
			<div class="pt-view pt-open" style="padding-left: 0px;">
				<!--带横线标题-->
				<div class="pt-bread">
					<h3>题目列表</h3>
					<!-- 添加展开按钮 -->
					<button type="button" id="ptsearchfilter" class="btn btn-primary pt-zkbtn">展开</button>
				</div>
				<div class="pt-main pt-padding">
					<!--搜索条-->
					<div class="pt-section-search">
						<form class="form-inline">
							<div class="row clearfix">
								<div class="col-lg-16 col-md-16 col-sm-14 col-xs-14 column">									   						
									<!-- 示例 input-->
									<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4">		
									 	<div class="form-group">									
											  <label class="col-lg-2 col-md-2 col-sm-2 col-xs-2" for="tmHtml">题目</label>
						                      <div class="col-lg-10 col-md-10 col-sm-10 col-xs-10">
						                        <input type="text" class="form-control" id="tmHtml" placeholder="题目">
						                      </div>									
										</div>
									</div>								
									<!-- 隐藏部分包裹 -->
									<span class="hiddenorshow pt-search-filter"> <!-- 示例 input-->
										<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4">
										    <div class="form-group">	
											    <label class="col-lg-2 col-md-2 col-sm-2 col-xs-2" for="title">分类</label>
					                            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
						                            <select id="catid" name="catid" class="selectpicker" data-actions-box="true" data-live-search="true" title="请选择"
														onchange="selOnchange()">
													    <option value="1" selected>法规类</option>
										                <option value="2">政策类</option>
										                <option value="3">收费类</option>
										                <option value="4">放行类</option>
										                <option value="5">理货类</option>
										                <option value="6">出口类</option>
										                <option value="7">进口类</option>
													</select>
												</div>
								             </div>
                           				</div>                           																											
									</span>
									<!-- 示例搜索按钮 -->
									<div class="col-lg-2 col-md-2 col-sm-2 col-xs-2">
										<div class="form-group">
											<button type="button" class="btn btn-default btn-primary w80" onclick="sel()">搜索</button>
										</div>
									</div>	
								</div>
							</form>
						</div>					
						
					<div class="col-lg-14 col-md-14 col-sm-14 col-xs-14 column">
						<div class="column pt-btn-line">
							<button type="button" class="btn w80 btn-default btn-primary"
								onclick="addItem()">新增</button>
						</div>
					</div>				
					  
						<!--内容区容器-->
						<div class="pt-main">
							<!--bootstrap 表格-->
							<div class="row">
								<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 column">
									<div class="table-wrap">
										<table id="tb_departments"></table>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!--主视口 结束-->
		</div>
	

	<script src="${gateway}/src/js/pt-tree.js"></script>
	<script>   
    //icheck 单选多选
      $('input').iCheck({
        radioClass : 'iradio_square-blue',
        increaseArea : '20%' // optional
      });   
      // 时间选择
    $('.datetimepicker').datetimepicker({
    language: 'zh',
    format: 'yyyy-mm-dd',
    minView: "month",
    pickDate: true,
    pickTime: false,
    todayBtn: true,
    autoclose: true
  });
    //搜索扩展
    $("#ptsearchfilter").click(function() {
      $(this).text($(".hiddenorshow").is(":hidden") ? "收起" : "展开");
      $(".hiddenorshow").toggleClass('pt-search-filter');
    });
  //初始化分类
    $.ajax({
      type : "post",
      url: '${gateway}/train/getTree/ptTree',
      data: {type:1},
      dataType : "json",
      success : function(result) {
        if (result.returnCode=='00') {
          var tree=[];
          tree.push(result.data.tree);
          $('#cate-tree').treeview({
            data : tree, // 数据源
            showCheckbox : true, //是否显示复选框
            multiSelect : false, //多选
            onNodeChecked : function(event, data) {
              selectTreeNode(data);
            }
          });
        } else {
          $('#cate-tree').treeview({
            data : [{text: '分类根节点', id: '0', pathName: '分类根节点'}], // 数据源
            showCheckbox : true, //是否显示复选框
            multiSelect : false, //多选
            onNodeChecked : function(event, data) {
              selectTreeNode(data);
            }
          });
        }
      },
      error : function() {
        $('#cate-tree').treeview({
          data : [{text: '分类根节点', id: '0', pathName: '分类根节点'}], // 数据源
          showCheckbox : true, //是否显示复选框
          multiSelect : false, //多选
          onNodeChecked : function(event, data) {
            selectTreeNode(data);
          }
        });
      }
    }); 
    
    // table
    // 2.返回操作模版[按钮颜色暂不确定]
    function operateFormatter(value, row, index) {
      var btnArray=[];      
      if (row.isvalid=='1') {
        btnArray.push('<button type="button" class="RoleOfdelete btn btn-xs btn-default btn-link-red" onclick="changeValid(\''+ value + '\', \''+row.tmHtml+'\',\''+row.parentName+'\', 0)">停用</button>');
      } else 
      if (row.isvalid=='0') {
        btnArray.push('<button type="button" class="RoleOfedit btn btn-xs btn-default btn-link" onclick=editItem("' + value + '")>修改</button>');
        btnArray.push('<button type="button" class="RoleOfdelete btn btn-xs btn-default btn-link-red pt-success" onclick="changeValid(\''+ value + '\', \''+row.tmHtml+'\',\''+row.parentName+'\', 1)">启用</button>');
      }
      btnArray.push('<button type="button" class="RoleOfdelete btn btn-xs btn-default btn-link-red" onclick="changeValid(\''+ value + '\', \''+row.tmHtml+'\',\''+row.parentName+'\', 2)">删除</button>');
      return btnArray.join('');
     
    }

    // 操作模版调用的方法
    function deleteItem(e) {
      var data = {
        "id":e,
        "isvalid":2,
        "kjList":"",
        "mnscList":""
      }
      var mymessage=confirm("确定要删除该题目信息吗？");
      if(mymessage==true){
        $.ajax({
          type : 'post',
          url : "${gateway}/st/update",
          data : data,
          dataType : 'json',
          cache : false,
          success : function(data) {
            $("#tb_departments").bootstrapTable('refresh');
          },
          error : function() { //失败回调函数
            alert("删除失败");
          }
        });
      } else if(mymessage==false){
        return false;
      }
    }
    
 // 操作停用
    function changeValid0(e) {
      var data = {
        "id":e,
        "isvalid":0,
        "kjList":"",
        "mnscList":""
      }
      var mymessage=confirm("确定要停用该题目信息吗？");
      if(mymessage==true){
        $.ajax({
          type : 'post',
          url : "${gateway}/st/update",
          data : data,
          dataType : 'json',
          cache : false,
          success : function(data) {
            $("#tb_departments").bootstrapTable('refresh');
          },
          error : function() { //失败回调函数
            alert("删除失败");
          }
        });
      } else if(mymessage==false){
        return false;
      }
    }
 
 
 // 操作启用
 function changeValid(e, tmHtml, pn, type) {
  if (type==1) {
    ajaxChangeValid(e, type);
  } else {   
    var ty="停用";
    if (type==2) ty="删除";
    if (type==2) {
      layer.confirm('要'+ty+'题目"'+tmHtml+'"吗？', {btn : [ '确定', '取消' ]},
        function(index) {
          layer.close(index);
          ajaxChangeValid(e, type);
        }
      );
    } else {
      ajaxChangeValid(e, type);
    }
  }
}
    function ajaxChangeValid(e,valid) {
      var data = {
        "id":e,
        "isvalid":valid,
        "kjList":"",
        "mnscList":""
      }
      $.ajax({
          type : 'post',
          url : "${gateway}/st/update",
          data : data,
          dataType : 'json',
          cache : false,
          success : function(data) {
            layer.msg((valid==1?"启用":(valid==2?"删除":"停用"))+"成功!");           
            $("#tb_departments").bootstrapTable('refresh');
          },
          error : function() { //失败回调函数
            alert("删除失败");
          }
        });     
    }
    function addItem() {
      layer.open({
        type : 2,//0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
        title : '<span class="text-color">添加题目信息</span>',//请修改span中间的内容
        shadeClose : true,//开启阴影关闭
        closeBtn : 1, //不显示关闭按钮
        shade : 0.6,
        maxmin : false,//开启最大化最小化按钮
        area : [ '80%', '100%' ],//此处可以改为100%，该数值按UI图比例算出
        content : '${gateway}/st/edit'//如果不想出现滚动条['content.html', 'no']        
      });
    }
    
    function editItem(e) {
        layer.open({
        type : 2,//0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
        title : '<span class="text-color">修改题目信息</span>',//请修改span中间的内容
        shadeClose : true,//开启阴影关闭
        closeBtn : 1, //不显示关闭按钮
        shade : 0.6,
        maxmin : false,//开启最大化最小化按钮
        area : [ '80%', '100%' ],//此处可以改为100%，该数值按UI图比例算出
        content : '${gateway}/st/edit?id='+e//如果不想出现滚动条['content.html', 'no']
      });
    }

    function lookItem(e) {
      layer.open({
        type : 2,//0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
        title : '<span class="text-color">查看课件信息</span>',//请修改span中间的内容
        shadeClose : true,//开启阴影关闭
        closeBtn : 1, //不显示关闭按钮
        shade : 0.6,
        maxmin : false,//开启最大化最小化按钮
        area : [ '62.5%', '83%' ],//此处可以改为100%，该数值按UI图比例算出
        content : 'kj/view?id='+e//如果不想出现滚动条['content.html', 'no']
      });
    }
    
    TableInit(queryParams).Init('${gateway}/st/getPageData', [ {
      field : 'tmHtml',
      title : '题目',
      sortable : false
    }, {
      field : 'catnames',
      title : '分类',
      sortable : false
    },{
      field : 'tmType',
      title : '类型',
      sortable : false
    }, {
      field : 'diffScore',
      title : '难度系数',
      sortable : false
    }, {
      field : 'isvalid',
      title : '是否启用',
      sortable : false,
      formatter: formatValid
    },{
      field : 'createName',
      title : '创建人',
      sortable : false
    },{
      field : 'createDate',
      title : '创建时间',
      sortable : false
    }, {
      field : 'id',
      title : '操作',
      formatter : operateFormatter
    }, ]);
    function queryParams(params) {
      return {
        tmHtml : $("#tmHtml").val(),
        kjid : $("#kjid").val(),       
        // 使用page size分页
        limit : params.limit, //页面大小
        offset : params.offset
      //页码
      };
    }
    //搜索
    function sel() {       
      $("#tb_departments").bootstrapTable('refresh');
    }
    function refresh() {
      $("#tb_departments").bootstrapTable('refresh');
    }
    function openKj() {
      if ( $("input[name='kjtype']:checked").val()==1){      
	      layer.open({
	        type : 2,//0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
	        title : '<span class="text-color">选择课件</span>',//请修改span中间的内容
	        shadeClose : true,//开启阴影关闭
	        closeBtn : 1, //不显示关闭按钮
	        shade : 0.6,
	        maxmin : false,//开启最大化最小化按钮
	        area : [ '70%', '90%' ],//此处可以改为100%，该数值按UI图比例算出
	        content : [ '${gateway}/kj/list4st?type=radio', 'yes' ]
	      //如果不想出现滚动条['content.html', 'no']
	      });
      }else{
        layer.open({
	        type : 2,//0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
	        title : '<span class="text-color">选择课件</span>',//请修改span中间的内容
	        shadeClose : true,//开启阴影关闭
	        closeBtn : 1, //不显示关闭按钮
	        shade : 0.6,
	        maxmin : false,//开启最大化最小化按钮
	        area : [ '70%', '90%' ],//此处可以改为100%，该数值按UI图比例算出
	        content : [ '${gateway}/mnsc/list4st?type=radio', 'yes' ]
	      //如果不想出现滚动条['content.html', 'no']
	      });
      }
    }
    function setVal(_valid, _valname) {
      $("#kjid").val(_valid);
      $("#kjname").val(_valname);
    }
    function setValmnsc(_valid, _valname) {
      $("#kjid").val(_valid);
      $("#kjname").val(_valname);
    }
    function formatValid(value) {
      if (value == '1') {        
        value ='<span class="pt-success">启用</span>';
      }
      else
        if (value == '0') {
          value = '<span class="pt-warn">停用</span>';
        }
      return value;
    }
    function selectTreeNode(treeNodeData) {
      console.log(treeNodeData);
      $("input[name='catnames']").val(treeNodeData.pathName);
      $("input[name='catid']").val(treeNodeData.id);
      $('#cate-tree').treeview('uncheckAll', { silent: true });
      $('#cate-tree').treeview('checkNode', [treeNodeData.nodeId, { silent: true }]);
      window.setTimeout(function(){/*
        $(".dropdown-menu").dropdown('toggle');
        $(".dropdown-menu").attr("data-stopPropagation","true");
        $(".dropdown-menu").on('click', function (e) {
          e.stopPropagation();
        });*/
      }, 500);
    }
  </script>
</body>
</html>