<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>input</title>
<!-- 1 bootstrap基础css -->
<link href="${gateway}/libs/bootstrap-3.3.7-dist/css/bootstrap.css"
    rel="stylesheet">
<!-- 2 table表格css -->
<link
    href="${gateway}/libs/bootstrap-3.3.7-dist/css/bootstrap-table.min.css"
    rel="stylesheet">
<!-- 3 treeview树css -->
<link
    href="${gateway}/libs/bootstrap-3.3.7-dist/css/bootstrap-treeview.min.css"
    rel="stylesheet">
<!-- 4 datetimepicker时间选择css -->
<link
    href="${gateway}/libs/bootstrap-3.3.7-dist/css/bootstrap-datetimepicker.min.css"
    rel="stylesheet">
<!-- 5 select选择框css -->
<link
    href="${gateway}/libs/bootstrap-3.3.7-dist/css/bootstrap-select.css"
    rel="stylesheet">
<!-- 6 fileinput上传文件css -->
<link href="${gateway}/libs/bootstrap-3.3.7-dist/css/fileinput.min.css"
    rel="stylesheet">
<!-- 7 icheck单选+多选css -->
<link href="${gateway}/libs/bootstrap-3.3.7-dist/css/icheck-blue.css"
    rel="stylesheet">
<!-- 8 Validator验证css -->
<link
    href="${gateway}/libs/bootstrap-3.3.7-dist/css/bootstrapValidator.min.css"
    rel="stylesheet">
<!-- 9 layer弹框css -->
<link href="${gateway}/libs/layer/layer-new.css" rel="stylesheet">
<!-- 10 引入字体css -->
<link href="${gateway}/libs/bootstrap-3.3.7-dist/fonts/iconfont.css"
    rel="stylesheet">
<!-- 11 页面样式css -->
<link href="${gateway}/src/css/pt-main.css" rel="stylesheet">

<!-- 优先引入jquery1.12.4版本 -->
<script src="${gateway}/libs/jquery/jquery-1.12.4.js"></script>
<!-- 1 bootstrap基础js -->
<script src="${gateway}/libs/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
<!-- 2 table表格js -->
<script
    src="${gateway}/libs/bootstrap-3.3.7-dist/js/bootstrap-table.min.js"></script>
<!-- 2 table列表数据js 可删除？ -->
<script
    src="${gateway}/libs/bootstrap-3.3.7-dist/js/bootstrap-table-data.js"></script>
<!-- 3 treeview树js -->
<script
    src="${gateway}/libs/bootstrap-3.3.7-dist/js/bootstrap-treeview.js"></script>
<!-- 4 datetimepicker时间选择js -->
<script
    src="${gateway}/libs/bootstrap-3.3.7-dist/js/bootstrap-datetimepicker.js"></script>
<!-- 5 select选择框js -->
<script
    src="${gateway}/libs/bootstrap-3.3.7-dist/js/bootstrap-select.min.js"></script>
<!-- 6 fileinput上传文件js -->
<script src="${gateway}/libs/bootstrap-3.3.7-dist/js/fileinput.min.js"></script>
<!-- 6 fileinput中文包js -->
<script
    src="${gateway}/libs/bootstrap-3.3.7-dist/js/fileinput_locale_zh.js"></script>
<!-- 7 icheck单选+多选js -->
<script src="${gateway}/libs/bootstrap-3.3.7-dist/js/icheck.min.js"></script>
<!-- 8 Validator验证js -->
<script
    src="${gateway}/libs/bootstrap-3.3.7-dist/js/bootstrapValidator.min.js"></script>
<!-- 9 layer弹框js -->
<script src="${gateway}/libs/layer/layer.js"></script>
<!-- 11 页面js -->
<script src="${gateway}/src/js/main.js"></script>
<style>
html {
    overflow-x: hidden;
    overflow-y: auto;
}
</style>
</head>
<body>
<br>
   <div class="container">
    <div class="row clearfix">
        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 column">
                  <form class="form-horizontal pt-form-full" role="form" id="form" name="form">                
                    <input type="hidden" name="id" id="objId">                                   
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="form-group">
                            <label class="col-lg-2 col-md-2 col-sm-2 col-xs-2"  for="title"><span> ※ </span>题目信息</label>
                            <div class="col-lg-10 col-md-10 col-sm-10 col-xs-10">
                                <textarea id="tmHtml" class="form-control" name="tmHtml" style="min-height: 108px"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="form-group">
                           <label class="col-lg-2 col-md-2 col-sm-2 col-xs-2" for="title"><span>※ </span>培训分类</label>
                           <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4">
                               <select id="catid" name="catid" class="selectpicker" data-live-search="true" title="请选择" onchange="selOnchange()">
                               </select>
                               <input type="hidden" class="form-control" name="catnames" id="catnames"/>
                           </div>
                           <label class="col-lg-2 col-md-2 col-sm-2 col-xs-2" for="diffScore">
                               <span> ※ </span>难度系数</label>                          
                               <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4">
                                  <select id="diffScore" name="diffScore" class="selectpicker"
                                    data-live-search="true" title="请选择">
                                    <option value="0">0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                </select>
                             </div>  
                        </div>
                    </div>
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="form-group">
                            <label class="col-lg-2 col-md-2 col-sm-2 col-xs-2"  for="title"><span> ※ </span>题目类型</label>
                            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4">
                                <select id="tmType" name="tmType" class="selectpicker"
                                    onchange="classify(this)" data-live-search="true" >
                                    <option value="单选题" checked>单选题</option>
                                    <option value="多选题">多选题</option>
                                    <option value="判断题">判断题</option>
                                </select>
                            </div>
                       
                        <label class="col-lg-2 col-md-2 col-sm-2 col-xs-2" for="title"><span> ※ </span>状态</label>
                        <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4">
                          <label class="radio-inline">
                            <input type="radio" name="isvalid" value="1" checked>启用
                          </label>
                          <label class="radio-inline">
                            <input type="radio" name="isvalid" value="0">停用
                          </label>
                        </div>
                      </div>
                    </div>
                    <input type="hidden" class="form-control" name="kjList"   id="kjList" />
                    <input type="hidden" id="kjnameList" class="form-control" name="kjnameList"/>
                    <input type="hidden" class="form-control" name="mnscList" id="mnscList" />
                    <input type="hidden" id="mnscnameList" class="form-control" name="mnscnameList"/>    
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" id="xzanswer"   style="display: none;">
                        <div class="form-group">
                            <label class="col-lg-2 col-md-2 col-sm-2 col-xs-2"  for="title"><span> ※ </span>判断题答案</label>
                            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4">
                                <label class="radio-inline"> <input type="radio"
                                    name="isAnswer" value="1"   checked> 正确
                                </label> <label class="radio-inline"> <input type="radio"
                                    name="isAnswer" value="2"  > 错误
                                </label>
                            </div>
                        </div>
                    </div>     
                 </form>
                     <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4" id="selectbtn" style="padding-left:10px;" >
                                 <button onclick="addTmcache()"  class="btn w120  btn btn-info" >添加选项及答案</button>                     
                             </div>   
                       </div>         
                <div class="pt-main" id = "pt-main" >
                    <!--bootstrap 表格-->
                    <div class="row">
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" style="padding-left:25px;" >
                            <div class="table-wrap" >
                                <br>
                                <table id="tb_departments"></table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group pt-btn-submit-layer">
                  <button onclick="addTm()" id="baocun" class="btn w160 btn-lg btn-default btn-primary">保存</button>
                  <button type="button" class="btn w160 btn-lg btn-default" onclick="closeMy()">取消</button>
                </div>
            </div>
        </div>

    <br>
    <script>
    //
    //table
    // 2.返回操作模版[按钮颜色暂不确定]
    function operateFormatter(value, row, index) {
      return [
          '<button type="button" class="RoleOfedit btn btn-xs btn-default btn-link" onclick=editItem("'
              + value + '")>修改</button>',
          '<button type="button" class="RoleOfdelete btn btn-xs btn-default btn-link-red" onclick=deleteItem("'
              + value + '")>删除</button>' ].join('');
    }
    $(function() {
      initCate();
      //icheck 单选多选
      $('input').iCheck({
        radioClass : 'iradio_square-blue',
        increaseArea : '20%' // optional
      });      
      //获取参数
      var url = location.search;
      if (url != '') {
        //变成修改
        $("#baocun").attr("onclick", "editTm()");
        url = url.substr(1);
        var split = url.split("=");
        split=split[1].substring(0,32);
        $.ajax({
          type : 'post',
          url : "${gateway}/st/get",
          data : {
            "id" : split
          },
          dataType : 'json',
          cache : false,
          success : function(data) {
            var tm = data.data;
            $("#objId").val(tm.id);
            $("#tmHtml").val(tm.tmHtml);
            
            $("input[type=radio][name=isvalid]").each(function (i, e) {
                 if (tm.isvalid == "1"){
                    if ($(this).val()==1) $(this).iCheck('check');   
                 }
                 else{
                    if ($(this).val()==0) $(this).iCheck('check');  
                 }
              }); 
            $("#catid").selectpicker('val', tm.catid); 
            $("#catnames").val(tm.catnames);
            $("#tmType").selectpicker('val', tm.tmType);  
            $("#diffScore").selectpicker('val',tm.diffScore);             
            if (tm.tmType=="判断题"){
                document.getElementById("xzanswer").style.display = "block";
                $("input[type=radio][name=isAnswer]").each(function (i, e) {
                   if (tm.tmSelectDesc == "错误"){
                      if ($(this).val()==2) $(this).iCheck('check');   
                   }
                   else{
                      if ($(this).val()==1) $(this).iCheck('check');  
                   }
                }); 
                document.getElementById("selectbtn").style.display = "none";
                document.getElementById("pt-main").style.display = "none";
            }else{
                document.getElementById("selectbtn").style.display = "block";
                document.getElementById("pt-main").style.display = "block";
                document.getElementById("xzanswer").style.display = "none";
            }    
            getDetailData(split);
          },
          error : function() { //失败回调函数
            alert("获取信息失败");
          }
        });
      }else{
        getDetailData();
      }
    });
    
  //初始化分类
    $.ajax({
      type : "post",
      url: '${gateway}/train/getTree/ptTree',
      data: {type:1},
      dataType : "json",
      success : function(result) {
        if (result.returnCode=='00') {
          var tree=[];
          tree.push(result.data.tree);
          $('#cate-tree').treeview({
            data : tree, // 数据源
            showCheckbox : true, //是否显示复选框
            multiSelect : false, //多选
            onNodeChecked : function(event, data) {
              selectTreeNode(data);
            }
          });
        } else {
          $('#cate-tree').treeview({
            data : [{text: '分类根节点', id: '0', pathName: '分类根节点'}], // 数据源
            showCheckbox : true, //是否显示复选框
            multiSelect : false, //多选
            onNodeChecked : function(event, data) {
              selectTreeNode(data);
            }
          });
        }
      },
      error : function() {
        $('#cate-tree').treeview({
          data : [{text: '分类根节点', id: '0', pathName: '分类根节点'}], // 数据源
          showCheckbox : true, //是否显示复选框
          multiSelect : false, //多选
          onNodeChecked : function(event, data) {
            selectTreeNode(data);
          }
        });
      }
    });      
    $('form').bootstrapValidator({
      message: 'This value is not valid',
      feedbackIcons: {
        valid: 'glyphicon glyphicon-ok',
        invalid: 'glyphicon glyphicon-remove',
        validating: 'glyphicon glyphicon-refresh'
      },
      fields: {
        tmHtml: {
          message: '题目不能为空',
          validators: {
            notEmpty: {
              message: '题目不能为空'
            }
          }
        },        
        diffScore: {
          message: '题目难度系数',
          validators: {
            notEmpty: {
              message: '必须录入题目难度系数'
            },
            regexp: {
              regexp: "^[0-9]$",
              message: '题目难度系数从0到9'
            }
          }
        },        
        catid: {
          message: '题目分类',
          validators: {
            notEmpty: {
              message: '必须选择题目分类'
            }
          }
        },        
        tmType: {
          message: '题目类型',
          validators: {
            notEmpty: {
              message: '必须选择题目类型'
            }
          }
        },    
      }
    });
    function getDetailData(tmId) {
      alert('${gateway}/st/getselctData?id=' + tmId);
      
      TableInit().Init('${gateway}/st/getselctData?id=' + tmId, [  {
        field : 'tmSelectSign',
        title : '选项标号',
        sortable : false
      }, {
        field : 'tmSelectDesc',
        title : '选项描述',
        sortable : false
      }, {
        field : 'sort',
        title : '显示顺序',
        sortable : false
      }, {
        field : 'isAnswer',
        title : '是否答案',
        sortable : false,
        formatter: formatisAnswer
      }, {
        field : 'id',
        title : '操作',
        formatter : operateFormatter
      } ]);
    }    
    function formatisAnswer(value) {      
      if (value == '1') {        
        value ='<span class="pt-success">是</span>';
      }
      else
        if (value == '0') {
          value = '<span class="pt-warn">否</span>';
        }
      return value;
    }
    function addTm() {
      var validatorObj=$('#form').data("bootstrapValidator");
      var aa=validatorObj.validate();
      var flag=validatorObj.isValid();
      $("#isvalid").val("1");
      if (!flag) return;
      $.ajax({
        type : 'post',
        url : "${gateway}/st/insert?isvalid=1",
        data : $("#form").serialize(),
        dataType : 'json',
        cache : false,
        success : function(data) {
          if (data.resultCode=='00') {
            try {
              parent.refresh("保存成功");
            } catch(e) {
              parent.document.getElementById("mainframe").contentWindow.refresh("保存成功");
            }
            closeMy(); 
          } else {
            layer.error("添加失败");
          }
        },
        error : function() { //失败回调函数
           layer.error("操作失败");
          //parent.refresh();
         // closeMy();         
        }
      });  
    }   
    function addTmcache() {
      if (!($("#objId").val())){        
          $.ajax({
            type : 'post',
            url : "${gateway}/st/insert?isvalid=3",
            data :  $("#form").serialize(),            
            dataType : 'json',
            cache : false,
            success : function(data) {
              if (data.resultCode=='00') {
                $("#objId").val(data.id);
                openAddSelect("3");
              } else {
                layer.error("异常无法操作");
              }
            },
            error : function() { //失败回调函数
              layer.error("异常无法操作");
              //parent.refresh();
             // closeMy();         
            }
          }); 
      }else{
        openAddSelect("1");
      }
    }   
    
    function editTm() {
      var validatorObj=$('#form').data("bootstrapValidator");
      var aa=validatorObj.validate();
      var flag=validatorObj.isValid();
      $("#isvalid").val("1");
      if (!flag) return;
      if ($("#isvalid").val()=="3")
        $("#isvalid").val("1");
      $.ajax({
        type : 'post',
        url : "${gateway}/st/update",
        data : $("#form").serialize(),
        dataType : 'json',
        cache : false,
        success : function(data) {           
          alert(parent.document.getElementById("mainframe").tmHtml);
          parent.document.getElementById("mainframe").refresh("保存成功");
          closeMy(); 
        },
        error : function() { //失败回调函数
          try {
            parent.refresh("保存成功");
          } catch(e) {
            parent.document.getElementById("mainframe").contentWindow.refresh("保存成功");
          }
          closeMy(); 
        }
      });
    }    
    function closeMy() {
      var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
      parent.layer.close(index); //再执行关闭
    }
    function openKj() {     
      layer.open({
        type : 2,//0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
        title : '<span class="text-color">选择课件</span>',//请修改span中间的内容
        shadeClose : true,//开启阴影关闭
        closeBtn : 1, //不显示关闭按钮
        shade : 0.6,
        maxmin : false,//开启最大化最小化按钮
        area : [ '80%', '90%' ],//此处可以改为100%，该数值按UI图比例算出
        content : [ '${gateway}/kj/list4st?type=checkbox', 'yes' ]
      //如果不想出现滚动条['content.html', 'no']
      });
    }
    function openMnsc() {
      layer.open({
        type : 2,//0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
        title : '<span class="text-color">选择模拟实操</span>',//请修改span中间的内容
        shadeClose : true,//开启阴影关闭
        closeBtn : 1, //不显示关闭按钮
        shade : 0.6,
        maxmin : false,//开启最大化最小化按钮
        area : [ '80%', '90%' ],//此处可以改为100%，该数值按UI图比例算出
        content : [ '${gateway}/mnsc/list4st?type=checkbox', 'yes' ]
      //如果不想出现滚动条['content.html', 'no']
      });
    }
    function openAddSelect(isvalid) {
      layer.open({
        type : 2,//0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
        title : '<span class="text-color">添加选项及答案</span>',//请修改span中间的内容
        shadeClose : true,//开启阴影关闭
        closeBtn : 1, //不显示关闭按钮
        shade : 0.6,
        maxmin : false,//开启最大化最小化按钮
        area : [ '90%', '80%' ],//此处可以改为100%，该数值按UI图比例算出
        content : [ '${gateway}/st/selectEdit?flag=0&isvalid='+isvalid+'&id='+$("#objId").val(), 'no' ]
      //如果不想出现滚动条['content.html', 'no']
      });
    }
    function setVal(_valList, _vanamelList) {
      $("#kjList").val(_valList);
      $("#kjnameList").val(_vanamelList);
    }
    function setValmnsc(_valList, _vanamelList) {
      $("#mnscList").val(_valList);
      $("#mnscnameList").val(_vanamelList);
    }
    function classify(obj) {      
      if (obj.selectedIndex == 2) {
        document.getElementById("xzanswer").style.display = "block";
        document.getElementById("selectbtn").style.display = "none";              
        document.getElementById("pt-main").style.display = "none";
      } else {
        document.getElementById("xzanswer").style.display = "none";
      }
      if (obj.selectedIndex == 0) {       
        document.getElementById("selectbtn").style.display = "block";              
        document.getElementById("pt-main").style.display = "block";
      }  else if (obj.selectedIndex == 1) {       
        document.getElementById("selectbtn").style.display = "block";              
        document.getElementById("pt-main").style.display = "block";
      } else{        
        document.getElementById("selectbtn").style.display = "none";
        document.getElementById("pt-main").style.display = "none";
      }
    }
    function editItem(e) {
      layer.open({
      type : 2,//0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
      title : '<span class="text-color">修改选项信息</span>',//请修改span中间的内容
      shadeClose : true,//开启阴影关闭
      closeBtn : 1, //不显示关闭按钮
      shade : 0.6,
      maxmin : false,//开启最大化最小化按钮
      area : [ '90%', '80%' ],//此处可以改为100%，该数值按UI图比例算出
      content : ['${gateway}/st/selectEdit?flag=1&id='+e,'no']//如果不想出现滚动条['content.html', 'no']  
    });
  }
  function deleteItem(e) {
      var data = {
        "id" : e
      }
      var mymessage = confirm("确定要删除该信息吗？");
      if (mymessage == true) {
        $.ajax({
          type : 'post',
          url : "${gateway}/st/deleteSelect",
          data : data,
          dataType : 'json',
          cache : false,
          success : function(data) {
            $("#tb_departments").bootstrapTable('refresh');
          },
          error : function() { //失败回调函数
            layer.msg("删除失败");
          }
        });
      } else if (mymessage == false) {
        return false;
      }
    }
  function refresh(msg) {
    if (msg) layer.msg(msg);
    $("#tb_departments").bootstrapTable('refresh');
  }
 
  function selOnchange() {
    var value = $("#catid  option:selected").text();
    $("#catnames").val(value);
  }
//渲染分类
function initCate() {
  $.ajax({
    type : "post",
    url: '${gateway}/train/getTree/ptTree',
    data: {type:0},
    dataType : "json",
    success : function(result) {
      if (result.returnCode=='00') {
        if (result.data&&result.data.tree&&result.data.tree.nodes) {
          var l=result.data.tree.nodes;
          for (var i=0;i<l.length;i++) {
            $('#catid.selectpicker').append("<option value="+l[i].id+">"+l[i].text+"</option>");
          }
          $('#catid.selectpicker').selectpicker('refresh')
        }
      }
    },
    error : function() {
    }
  });
}
  </script>
</body>
</html>